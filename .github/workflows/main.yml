name: Build & Release PyWarp

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'The version to build and release'
        required: true
        default: '1.2.8'

permissions:
  contents: write

jobs:
  validate:
    name: Validate Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install flake8
      - name: Run Flake8 (fail on error)
        run: flake8 .

  build-windows-x64:
    name: Build Windows x64 (portable)
    runs-on: windows-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-build
      
      - name: Build Portable Windows x64 Executable (onefile)
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version }}"
          python -m nuitka main.py `
            --standalone `
            --onefile `
            --disable-console `
            --enable-plugin=pyside6 `
            --nofollow-import-to=PySide6.QtSql,PySide6.QtQml,PySide6.QtQuick,PySide6.QtMultimedia,PySide6.QtWebEngineCore,PySide6.QtWebEngineWidgets,PySide6.QtWebEngineQuick,PySide6.QtBluetooth,PySide6.QtPositioning `
            --include-data-dir=assets=assets `
            --include-qt-plugins=platforms,styles,imageformats,iconengines `
            --windows-icon-from-ico=assets/logo.ico `
            --windows-product-name="PyWarp" `
            --windows-file-version="$version" `
            --output-dir=dist `
            --output-filename="pywarp-windows-x64-v$version" `
            --assume-yes-for-downloads
      - name: Zip Portable Executable
        run: |
          cd dist
          powershell Compress-Archive -Path "pywarp-windows-x64-v${{ github.event.inputs.version }}.exe" -DestinationPath "pywarp-windows-x64-v${{ github.event.inputs.version }}.zip"
      - uses: actions/upload-artifact@v4
        with:
          name: pywarp-windows-x64
          path: dist/pywarp-windows-x64-v${{ github.event.inputs.version }}.zip

  build-windows-x86:
    name: Build Windows x86 (portable)
    runs-on: windows-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-build
        with:
          architecture: 'x86'
          
      - name: Build Portable Windows x86 Executable (onefile)
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version }}"
          python -m nuitka main.py `
            --standalone `
            --onefile `
            --disable-console `
            --enable-plugin=pyside6 `
            --nofollow-import-to=PySide6.QtSql,PySide6.QtQml,PySide6.QtQuick,PySide6.QtMultimedia,PySide6.QtWebEngineCore,PySide6.QtWebEngineWidgets,PySide6.QtWebEngineQuick,PySide6.QtBluetooth,PySide6.QtPositioning `
            --include-data-dir=assets=assets `
            --include-qt-plugins=platforms,styles,imageformats,iconengines `
            --windows-icon-from-ico=assets/logo.ico `
            --windows-product-name="PyWarp" `
            --windows-file-version="$version" `
            --output-dir=dist `
            --output-filename="pywarp-windows-x86-v$version" `
            --assume-yes-for-downloads
      - name: Zip Portable Executable
        run: |
          cd dist
          powershell Compress-Archive -Path "pywarp-windows-x86-v${{ github.event.inputs.version }}.exe" -DestinationPath "pywarp-windows-x86-v${{ github.event.inputs.version }}.zip"
      - uses: actions/upload-artifact@v4
        with:
          name: pywarp-windows-x86
          path: dist/pywarp-windows-x86-v${{ github.event.inputs.version }}.zip

  build-linux-x64:
    name: Build Linux x64 (portable)
    runs-on: ubuntu-22.04
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-build

      - name: Build Portable Linux Executable (onefile)
        run: |
          python -m nuitka main.py \
            --standalone \
            --onefile \
            --remove-output \
            --disable-console \
            --enable-plugin=pyside6 \
            --nofollow-import-to=PySide6.QtSql,PySide6.QtQml,PySide6.QtQuick,PySide6.QtMultimedia,PySide6.QtWebEngineCore,PySide6.QtWebEngineWidgets,PySide6.QtWebEngineQuick,PySide6.QtBluetooth,PySide6.QtPositioning \
            --include-data-dir=assets=assets \
            --include-qt-plugins=platforms,styles,imageformats,iconengines \
            --linux-onefile-icon=assets/logo.xpm \
            --output-filename="pywarp-linux-x64-v${{ github.event.inputs.version }}" \
            --output-dir=dist \
            --assume-yes-for-downloads
      - name: Create tar.gz
        run: |
          tar -czvf pywarp-linux-x64-v${{ github.event.inputs.version }}.tar.gz -C dist pywarp-linux-x64-v${{ github.event.inputs.version }}
      - uses: actions/upload-artifact@v4
        with:
          name: pywarp-linux-x64
          path: pywarp-linux-x64-v${{ github.event.inputs.version }}.tar.gz

  build-linux-x86:
    name: Build Linux x86 (portable) - best-effort
    runs-on: ubuntu-22.04
    needs: validate
    container:
      image: i386/ubuntu:22.04
    steps:
      - uses: actions/checkout@v4
      - name: Install system deps (i386)
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y python3 python3-pip python3-venv build-essential gcc-multilib g++-multilib
          python3 -m pip install --upgrade pip

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-i386-${{ hashFiles('requirements.txt') }}

      - name: Install Python dependencies (i386)
        run: |
          # CRITICAL FIX: Install requirements.txt
          python3 -m pip install -r requirements.txt
          python3 -m pip install nuitka==2.6
          
      - name: Build Portable Linux 32-bit Executable (onefile)
        run: |
          python3 -m nuitka main.py \
            --standalone \
            --onefile \
            --remove-output \
            --disable-console \
            --enable-plugin=pyside6 \
            --nofollow-import-to=PySide6.QtSql,PySide6.QtQml,PySide6.QtQuick,PySide6.QtMultimedia,PySide6.QtWebEngineCore,PySide6.QtWebEngineWidgets,PySide6.QtWebEngineQuick,PySide6.QtBluetooth,PySide6.QtPositioning \
            --include-data-dir=assets=assets \
            --include-qt-plugins=platforms,styles,imageformats,iconengines \
            --linux-onefile-icon=assets/logo.xpm \
            --output-filename="pywarp-linux-x86-v${{ github.event.inputs.version }}" \
            --output-dir=dist \
            --assume-yes-for-downloads
      - name: Create tar.gz
        run: |
          tar -czvf pywarp-linux-x86-v${{ github.event.inputs.version }}.tar.gz -C dist pywarp-linux-x86-v${{ github.event.inputs.version }}
      - uses: actions/upload-artifact@v4
        with:
          name: pywarp-linux-x86
          path: pywarp-linux-x86-v${{ github.event.inputs.version }}.tar.gz

  build-macos-universal:
    name: Build macOS Universal (portable)
    runs-on: macos-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-build
      
      - name: Build macOS Universal App (Nuitka)
        run: |
          python -m nuitka main.py \
            --standalone \
            --remove-output \
            --disable-console \
            --macos-create-app-bundle \
            --macos-universal \
            --macos-app-name="PyWarp" \
            --macos-app-icon=assets/logo.icns \
            --macos-app-version="${{ github.event.inputs.version }}" \
            --enable-plugin=pyside6 \
            --nofollow-import-to=PySide6.QtSql,PySide6.QtQml,PySide6.QtQuick,PySide6.QtMultimedia,PySide6.QtWebEngineCore,PySide6.QtWebEngineWidgets,PySide6.QtWebEngineQuick,PySide6.QtBluetooth,PySide6.QtPositioning \
            --include-data-dir=assets=assets \
            --include-qt-plugins=platforms,styles,imageformats,iconengines \
            --output-dir=. \
            --clang \
            --assume-yes-for-downloads \
            --disable-ccache
      - name: Rename .app bundle
        run: |
          mv PyWarp.app "PyWarp-v${{ github.event.inputs.version }}.app"
      - name: Create DMG (unsigned)
        run: |
          cat > README_mac_unsigned.txt << 'EOF'
          ðŸ“¦ PyWarp for macOS (Unsigned Build)

          This app is not signed with an Apple Developer ID. To open it:
          - Right-click â†’ Open â†’ Confirm
          or run:
            xattr -dr com.apple.quarantine /Applications/PyWarp.app
          EOF

          hdiutil create \
            -volname "PyWarp" \
            -srcfolder "PyWarp-v${{ github.event.inputs.version }}.app" \
            -srcfolder README_mac_unsigned.txt \
            -format UDZO \
            -ov \
            -o "pywarp-macos-universal-v${{ github.event.inputs.version }}.dmg"
      - uses: actions/upload-artifact@v4
        with:
          name: pywarp-macos-universal
          path: pywarp-macos-universal-v${{ github.event.inputs.version }}.dmg

release:
    name: Create GitHub Release
    runs-on: ubuntu-22.04
    needs: [build-windows-x64, build-windows-x86, build-linux-x64, build-linux-x86, build-macos-universal]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract Changelog
        run: |
          # Extract release notes for the current version from CHANGELOG.md
          awk -v ver="v${{ github.event.inputs.version }}" '
            $0 ~ "^## " ver {flag=1; next}
            flag && /^## / {exit}
            flag {print}
          ' CHANGELOG.md > RELEASE_NOTES.md
          echo -e "\n---\nBuilt for Windows, Linux, and macOS (Universal)\n" >> RELEASE_NOTES.md

      - name: Generate Checksums and Download Matrix
        run: | # <-- The pipe '|' is critical here, and the following lines must be indented
          REPO="${{ github.repository }}"
          VERSION="${{ github.event.inputs.version }}"
          TAG="v$VERSION"

          WIN_X64_FILE=$(find artifacts -name "pywarp-windows-x64-*.zip" | head -n1)
          WIN_X86_FILE=$(find artifacts -name "pywarp-windows-x86-*.zip" | head -n1)
          LINUX_X64_FILE=$(find artifacts -name "pywarp-linux-x64-*.tar.gz" | head -n1)
          LINUX_X86_FILE=$(find artifacts -name "pywarp-linux-x86-*.tar.gz" | head -n1)
          MAC_FILE=$(find artifacts -name "pywarp-macos-universal-*.dmg" | head -n1)

          WIN_X64_SHA=$(sha256sum "$WIN_X64_FILE" | cut -d' ' -f1)
          WIN_X86_SHA=$(sha256sum "$WIN_X86_FILE" | cut -d' ' -f1)
          LINUX_X64_SHA=$(sha256sum "$LINUX_X64_FILE" | cut -d' ' -f1)
          LINUX_X86_SHA=$(sha256sum "$LINUX_X86_FILE" | cut -d' ' -f1)
          MAC_SHA=$(sha256sum "$MAC_FILE" | cut -d' ' -f1)

          WIN_X64_SIZE=$(du -h "$WIN_X64_FILE" | cut -f1)
          WIN_X86_SIZE=$(du -h "$WIN_X86_FILE" | cut -f1)
          LINUX_X64_SIZE=$(du -h "$LINUX_X64_FILE" | cut -f1)
          LINUX_X86_SIZE=$(du -h "$LINUX_X86_FILE" | cut -f1)
          MAC_SIZE=$(du -h "$MAC_FILE" | cut -f1)

          cat >> RELEASE_NOTES.md << EOF

          ## ðŸ§© Downloads

          <table>
            <thead>
              <tr><th>Downloads</th><th>Compatibility</th></tr>
            </thead>
            <tbody>

              <tr>
                <td>
                  <a href="https://github.com/$REPO/releases/download/$TAG/pywarp-windows-x64-v$VERSION.zip"><img src="https://img.shields.io/badge/Windows-x64-0078D6?style=for-the-badge&logo=windows" alt="Windows x64"/></a>
                  <a href="https://github.com/$REPO/releases/download/$TAG/pywarp-windows-x86-v$VERSION.zip"><img src="https://img.shields.io/badge/Windows-x86-1E90FF?style=for-the-badge&logo=windows" alt="Windows x86"/></a>
                </td>
                <td class="compat">Windows 10+</td>
              </tr>

              <tr>
                <td>
                  <a href="https://github.com/$REPO/releases/download/$TAG/pywarp-macos-universal-v$VERSION.dmg"><img src="https://img.shields.io/badge/macOS-Universal-999999?style=for-the-badge&logo=apple" alt="macOS Universal"/></a>
                </td>
                <td class="compat">macOS 10.15+</td>
              </tr>

              <tr>
                <td>
                  <a href="https://github.com/$REPO/releases/download/$TAG/pywarp-linux-x64-v$VERSION.tar.gz"><img src="https://img.shields.io/badge/Linux-x64-F0C419?style=for-the-badge&logo=linux" alt="Linux x64"/></a>
                  <a href="https://github.com/$REPO/releases/download/$TAG/pywarp-linux-x86-v$VERSION.tar.gz"><img src="https://img.shields.io/badge/Linux-x86-F7A600?style=for-the-badge&logo=linux" alt="Linux x86"/></a>
                </td>
                <td class="compat">GNOME / KDE</td>
              </tr>

            </tbody>
          </table>

          ### Checksums
          - Windows x64: \`$WIN_X64_SHA\` ($WIN_X64_SIZE)
          - Windows x86: \`$WIN_X86_SHA\` ($WIN_X86_SIZE)
          - Linux x64: \`$LINUX_X64_SHA\` ($LINUX_X64_SIZE)
          - Linux x86: \`$LINUX_X86_SHA\` ($LINUX_X86_SIZE)
          - macOS: \`$MAC_SHA\` ($MAC_SIZE)

          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: PyWarp v${{ github.event.inputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: true
          files: |
            artifacts/**/pywarp-windows-x64-*.zip
            artifacts/**/pywarp-windows-x86-*.zip
            artifacts/**/pywarp-linux-x64-*.tar.gz
            artifacts/**/pywarp-linux-x86-*.tar.gz
            artifacts/**/pywarp-macos-universal-*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}