name: Build & Release PyWarp

on:
  workflow_dispatch:
    inputs:
      version:
        description: "The version to build and release"
        required: true
        default: "1.2.8"

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install Dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install -r requirements.txt flake8

      - name: Run Flake8
        run: flake8 .

  build-windows-x64:
    runs-on: windows-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: ./.github/actions/setup-build

      - name: Build Windows x64
        shell: pwsh
        run: |
          & .\.venv\Scripts\activate
          $version = "${{ github.event.inputs.version }}"
          python -m nuitka main.py `
            --standalone `
            --onefile `
            --disable-console `
            --enable-plugin=pyside6 `
            --nofollow-import-to=PySide6.QtSql,PySide6.QtQml,PySide6.QtQuick,PySide6.QtMultimedia,PySide6.QtWebEngineCore,PySide6.QtWebEngineWidgets,PySide6.QtWebEngineQuick,PySide6.QtBluetooth,PySide6.QtPositioning `
            --include-data-dir=assets=assets `
            --include-qt-plugins=platforms,imageformats,iconengines `
            --windows-icon-from-ico=assets/logo.ico `
            --windows-product-name="PyWarp" `
            --windows-file-version="$version" `
            --output-dir=dist `
            --output-filename="pywarp-windows-x64-v$version.exe" `
            --assume-yes-for-downloads

      - name: Zip Output
        shell: pwsh
        run: |
          Compress-Archive dist\pywarp-windows-x64-v${{ github.event.inputs.version }}.exe `
            dist\pywarp-windows-x64-v${{ github.event.inputs.version }}.zip

      - uses: actions/upload-artifact@v4
        with:
          name: pywarp-windows-x64
          path: dist/pywarp-windows-x64-v${{ github.event.inputs.version }}.zip

  build-linux-x64:
    runs-on: ubuntu-22.04
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: ./.github/actions/setup-build

      - name: Build Linux x64
        run: |
          source .venv/bin/activate
          VERSION="${{ github.event.inputs.version }}"
          python -m nuitka main.py \
            --standalone \
            --onefile \
            --remove-output \
            --disable-console \
            --enable-plugin=pyside6 \
            --nofollow-import-to=PySide6.QtSql,PySide6.QtQml,PySide6.QtQuick,PySide6.QtMultimedia,PySide6.QtWebEngineCore,PySide6.QtWebEngineWidgets,PySide6.QtWebEngineQuick,PySide6.QtBluetooth,PySide6.QtPositioning \
            --include-data-dir=assets=assets \
            --include-qt-plugins=platforms,imageformats,iconengines \
            --linux-onefile-icon=assets/logo.xpm \
            --output-filename="pywarp-linux-x64-v$VERSION" \
            --output-dir=dist \
            --assume-yes-for-downloads

      - name: TAR
        run: |
          tar -czvf pywarp-linux-x64-v${{ github.event.inputs.version }}.tar.gz \
            -C dist pywarp-linux-x64-v${{ github.event.inputs.version }}

      - uses: actions/upload-artifact@v4
        with:
          name: pywarp-linux-x64
          path: pywarp-linux-x64-v${{ github.event.inputs.version }}.tar.gz

  build-macos-universal:
    runs-on: macos-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: ./.github/actions/setup-build

      - name: Build macOS App
        run: |
          source .venv/bin/activate
          python -m nuitka main.py \
            --standalone \
            --remove-output \
            --disable-console \
            --macos-create-app-bundle \
            --macos-app-name="PyWarp" \
            --macos-app-icon=assets/logo.icns \
            --macos-app-version="${{ github.event.inputs.version }}" \
            --enable-plugin=pyside6 \
            --nofollow-import-to=PySide6.QtSql,PySide6.QtQml,PySide6.QtQuick,PySide6.QtMultimedia,PySide6.QtWebEngineCore,PySide6.QtWebEngineWidgets,PySide6.QtWebEngineQuick,PySide6.QtBluetooth,PySide6.QtPositioning \
            --include-data-dir=assets=assets \
            --include-qt-plugins=platforms,imageformats,iconengines \
            --output-dir=. \
            --assume-yes-for-downloads \
            --disable-ccache

      - run: mv PyWarp.app "PyWarp-v${{ github.event.inputs.version }}.app"

      - name: Create DMG
        run: |
          hdiutil create \
            -volname "PyWarp" \
            -srcfolder "PyWarp-v${{ github.event.inputs.version }}.app" \
            -format UDZO \
            -ov \
            -o "pywarp-macos-universal-v${{ github.event.inputs.version }}.dmg"

      - uses: actions/upload-artifact@v4
        with:
          name: pywarp-macos-universal
          path: pywarp-macos-universal-v${{ github.event.inputs.version }}.dmg

  release:
    name: Create GitHub Release
    runs-on: ubuntu-22.04
    needs:
      - build-windows-x64
      - build-linux-x64
      - build-macos-universal

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract Changelog Section
        run: |
          VERSION="v${{ github.event.inputs.version }}"
          awk -v ver="$VERSION" '
            $0 ~ "^## " ver {flag=1; next}
            flag && /^## / {exit}
            flag {print}
          ' CHANGELOG.md > RELEASE_NOTES.md

      - name: Generate Checksums + Download Table
        shell: bash
        run: |
          REPO="${{ github.repository }}"
          VERSION="${{ github.event.inputs.version }}"
          TAG="v$VERSION"

          WIN_X64=$(find artifacts -name "*windows-x64*.zip" | head -n1 || true)
          LINUX_X64=$(find artifacts -name "*linux-x64*.tar.gz" | head -n1 || true)
          MAC=$(find artifacts -name "*macos-universal*.dmg" | head -n1 || true)

          cat >> RELEASE_NOTES.md <<EOF

            ## ðŸ§© Downloads

            <table>
              <thead>
                <tr><th>Download</th><th>Compatibility</th></tr>
              </thead>
              <tbody>

                <tr>
                  <td>
                    <a href="https://github.com/$REPO/releases/download/$TAG/pywarp-windows-x64-v$VERSION.zip">
                      Windows (x64)
                    </a>
                  </td>
                  <td>Windows 10+</td>
                </tr>

                <tr>
                  <td>
                    <a href="https://github.com/$REPO/releases/download/$TAG/pywarp-macos-universal-v$VERSION.dmg">
                      macOS (Universal)
                    </a>
                  </td>
                  <td>macOS 10.15+</td>
                </tr>

                <tr>
                  <td>
                    <a href="https://github.com/$REPO/releases/download/$TAG/pywarp-linux-x64-v$VERSION.tar.gz">
                      Linux (x64)
                    </a>
                  </td>
                  <td>GNOME / KDE</td>
                </tr>

              </tbody>
            </table>

            EOF

          echo "" >> RELEASE_NOTES.md
          echo "## ðŸ” Checksums" >> RELEASE_NOTES.md

          for file in "$WIN_X64" "$LINUX_X64" "$MAC"; do
            if [ -f "$file" ]; then
              sha=$(sha256sum "$file" | cut -d' ' -f1)
              name=$(basename "$file")
              echo "- **$name:** \`$sha\`" >> RELEASE_NOTES.md
            fi
          done

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: PyWarp v${{ github.event.inputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            artifacts/**/*windows*.zip
            artifacts/**/*linux*.tar.gz
            artifacts/**/*macos*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}