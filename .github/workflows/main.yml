name: Build & Release PyWarp

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'The version to build and release'
        required: true
        default: '1.2.8'

permissions:
  contents: write

jobs:
  validate:
    name: Validate Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
      - name: Install flake8
        run: pip install flake8
      - name: Run Flake8 (fail on error)
        run: flake8 .

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka==2.6
      - name: Build Executable
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version }}"
          python -m nuitka main.py `
            --standalone `
            --onefile `
            --disable-console `
            --enable-plugin=pyside6 `
            --include-data-dir=assets=assets `
            --include-qt-plugins=platforms,styles,imageformats,iconengines `
            --nofollow-import-to=PySide6.QtSql,PySide6.QtQml,PySide6.QtQuick,PySide6.QtMultimedia,PySide6.QtWebEngineCore,PySide6.QtWebEngineWidgets,PySide6.QtWebEngineQuick,PySide6.QtBluetooth,PySide6.QtPositioning `
            --noinclude-pytest-mode=nofollow `
            --noinclude-unittest-mode=nofollow `
            --nofollow-import-to=tkinter,test,pydoc `
            --windows-icon-from-ico=assets/logo.ico `
            --output-dir=dist `
            --output-filename="pywarp-windows-v$version" `
            --windows-company-name="PyWarp" `
            --windows-product-name="PyWarp" `
            --windows-file-version="$version" `
            --windows-product-version="$version" `
            --remove-output `
            --assume-yes-for-downloads

      - name: Self-sign Executable (auto)
        shell: pwsh
        run: |
          $exe = "dist\\pywarp-windows-v${{ github.event.inputs.version }}.exe"
          Write-Host "ðŸ” Generating temporary self-signed certificate..."
          $cert = New-SelfSignedCertificate -Type CodeSigningCert -Subject "CN=PyWarp CI" -CertStoreLocation Cert:\CurrentUser\My
          $pwd = ConvertTo-SecureString -String "temporarypass" -Force -AsPlainText
          $pfxPath = "$env:USERPROFILE\\pywarp_temp.pfx"
          Export-PfxCertificate -Cert $cert -FilePath $pfxPath -Password $pwd

          Write-Host "ðŸ” Locating signtool..."
          # Use recursive glob (**) for better compatibility with different Windows SDK versions
          $sdkPaths = @(
            "C:\Program Files (x86)\Windows Kits\10\bin\**\x64\signtool.exe",
            "C:\Program Files (x86)\Windows Kits\10\bin\**\x86\signtool.exe"
          )
          
          # Find the newest signtool.exe by LastWriteTime
          $signtool = Get-ChildItem -Path $sdkPaths -ErrorAction SilentlyContinue | Sort-Object -Descending -Property LastWriteTime | Select-Object -First 1

          if (-not $signtool) {
            # Fallback to check if it's already on the PATH
            $signtool = (Get-Command signtool.exe -ErrorAction SilentlyContinue).Source
          }
          if (-not $signtool) {
            throw "âŒ signtool.exe not found! Checked: $sdkPaths"
          }

          Write-Host "ðŸ” Using signtool at $($signtool.FullName)"
          & "$($signtool.FullName)" sign `
            /f $pfxPath /p "temporarypass" `
            /tr http://timestamp.digicert.com /td SHA256 /fd SHA256 $exe

          Remove-Item $pfxPath -Force
          Write-Host "âœ… Self-signed and cleaned up certificate."

      - name: Zip Executable
        run: |
          cd dist
          powershell Compress-Archive -Path pywarp-windows-v${{ github.event.inputs.version }}.exe -DestinationPath pywarp-windows-v${{ github.event.inputs.version }}.zip
      - uses: actions/upload-artifact@v4
        with:
          name: pywarp-windows
          path: dist/pywarp-windows-v${{ github.event.inputs.version }}.zip

  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka==2.6
      - name: Build Executable
        run: |
          python -m nuitka main.py \
            --standalone \
            --onefile \
            --remove-output \
            --disable-console \
            --enable-plugin=pyside6 \
            --include-data-dir=assets=assets \
            --include-qt-plugins=platforms,imageformats,iconengines \
            --nofollow-import-to=PySide6.QtSql,PySide6.QtQml,PySide6.QtQuick,PySide6.QtMultimedia,PySide6.QtWebEngineCore,PySide6.QtWebEngineWidgets,PySide6.QtWebEngineQuick,PySide6.QtBluetooth,PySide6.QtPositioning \
            --output-filename="pywarp-ubuntu-v${{ github.event.inputs.version }}" \
            --output-dir=dist
      - name: Create tar.gz
        run: |
          tar -czvf pywarp-ubuntu-v${{ github.event.inputs.version }}.tar.gz -C dist pywarp-ubuntu-v${{ github.event.inputs.version }}
      - uses: actions/upload-artifact@v4
        with:
          name: pywarp-ubuntu
          path: pywarp-ubuntu-v${{ github.event.inputs.version }}.tar.gz

  build-macos-universal:
    name: Build macOS Universal
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka==2.6
      - name: Build PyWarp for ${{ matrix.arch }}
        run: |
          python -m nuitka main.py \
            --standalone \
            --remove-output \
            --disable-console \
            --enable-plugin=pyside6 \
            --macos-create-app-bundle \
            --macos-app-name="pywarp-${{ matrix.arch }}" \
            --macos-app-icon=assets/logo.icns \
            --macos-app-version="${{ github.event.inputs.version }}" \
            --include-data-dir=assets=assets \
            --include-qt-plugins=platforms,styles,imageformats,iconengines \
            --nofollow-import-to=PySide6.QtSql,PySide6.QtQml,PySide6.QtQuick,PySide6.QtMultimedia,PySide6.QtWebEngineCore,PySide6.QtWebEngineWidgets,PySide6.QtWebEngineQuick,PySide6.QtBluetooth,PySide6.QtPositioning \
            --output-dir=. \
            --clang \
            --macos-target-arch=${{ matrix.arch }} \
            --assume-yes-for-downloads \
            --disable-ccache
      - name: Rename .app bundle
        run: |
          mv main.app "pywarp-v${{ github.event.inputs.version }}-${{ matrix.arch }}.app"
      - name: Zip .app bundle
        run: |
          APP_PATH="pywarp-v${{ github.event.inputs.version }}-${{ matrix.arch }}.app"
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "pywarp-${{ matrix.arch }}.zip"
      - uses: actions/upload-artifact@v4
        with:
          name: pywarp-${{ matrix.arch }}
          path: pywarp-${{ matrix.arch }}.zip

  merge-macos-universal:
    name: Merge & Create macOS Universal DMG
    runs-on: macos-latest
    needs: build-macos-universal
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Merge .app bundles into universal
        run: |
          mkdir -p artifacts/unzipped
          ditto -x -k artifacts/pywarp-x86_64/pywarp-x86_64.zip artifacts/unzipped
          ditto -x -k artifacts/pywarp-arm64/pywarp-arm64.zip artifacts/unzipped
          APP_X86=$(find artifacts/unzipped -name '*.app' -path '*x86_64.app' -type d | head -n1)
          APP_ARM=$(find artifacts/unzipped -name '*.app' -path '*arm64.app' -type d | head -n1)
          BIN_X86="$APP_X86/Contents/MacOS/main"
          BIN_ARM="$APP_ARM/Contents/MacOS/main"
          UNIVERSAL_APP_PATH="$APP_ARM"
          UNIVERSAL_BIN_PATH="$BIN_ARM"
          lipo -create "$BIN_X86" "$BIN_ARM" -output "$UNIVERSAL_BIN_PATH"
          chmod +x "$UNIVERSAL_BIN_PATH"
          mv "$UNIVERSAL_APP_PATH" "PyWarp-v${{ github.event.inputs.version }}.app"
      - name: Add unsigned instructions and create DMG
        run: |
          cat > README_mac_unsigned.txt << 'EOF'
          ðŸ“¦ PyWarp for macOS (Unsigned Build)

          This app is not signed with an Apple Developer ID. To open it:
          - Right-click â†’ Open â†’ Confirm
          or run:
            xattr -dr com.apple.quarantine /Applications/PyWarp.app
          EOF
          hdiutil create \
            -volname "PyWarp" \
            -srcfolder "PyWarp-v${{ github.event.inputs.version }}.app" \
            -srcfolder README_mac_unsigned.txt \
            -format UDZO \
            -ov \
            -o "./pywarp-macos-universal-v${{ github.event.inputs.version }}.dmg"
      - uses: actions/upload-artifact@v4
        with:
          name: pywarp-macos-universal
          path: pywarp-macos-universal-v${{ github.event.inputs.version }}.dmg

  release:
    name: Create GitHub Release
    runs-on: ubuntu-22.04
    needs: [build-windows, build-linux, merge-macos-universal]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract Changelog
        run: |
          # Extract release notes for the current version from CHANGELOG.md
          awk -v ver="v${{ github.event.inputs.version }}" '
            $0 ~ "^## " ver {flag=1; next}
            flag && /^## / {exit}
            flag {print}
          ' CHANGELOG.md > RELEASE_NOTES.md
          echo -e "\n---\nBuilt for Windows, Linux, and macOS (Universal)\n" >> RELEASE_NOTES.md
      
      - name: Generate Checksums and Professional Download Table
        run: |
          REPO="${{ github.repository }}"
          TAG="v${{ github.event.inputs.version }}"
          VERSION="${{ github.event.inputs.version }}"

          WIN_FILE=$(find artifacts -name "pywarp-windows-*.zip" | head -n1)
          LINUX_FILE=$(find artifacts -name "pywarp-ubuntu-*.tar.gz" | head -n1)
          MAC_FILE=$(find artifacts -name "pywarp-macos-universal-*.dmg" | head -n1)

          # Calculate SHA256 and size (MB)
          WIN_SHA=$(sha256sum "$WIN_FILE" | cut -d' ' -f1)
          LINUX_SHA=$(sha256sum "$LINUX_FILE" | cut -d' ' -f1)
          MAC_SHA=$(sha256sum "$MAC_FILE" | cut -d' ' -f1)

          WIN_SIZE=$(du -h "$WIN_FILE" | cut -f1)
          LINUX_SIZE=$(du -h "$LINUX_FILE" | cut -f1)
          MAC_SIZE=$(du -h "$MAC_FILE" | cut -f1)

          echo "### ðŸš€ Download PyWarp v$VERSION" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "You can download the builds for your platform below. All files are signed or verified and include SHA256 checksums for integrity." >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "| Platform | File | Size | SHA256 |" >> RELEASE_NOTES.md
          echo "|-----------|------|------|--------|" >> RELEASE_NOTES.md
          echo "| ðŸªŸ **Windows** | [pywarp-windows-v$VERSION.zip](https://github.com/$REPO/releases/download/v$VERSION/pywarp-windows-v$VERSION.zip) | $WIN_SIZE | \`$WIN_SHA\` |" >> RELEASE_NOTES.md
          echo "| ðŸ§ **Linux (Ubuntu)** | [pywarp-ubuntu-v$VERSION.tar.gz](https://github.com/$REPO/releases/download/v$VERSION/pywarp-ubuntu-v$VERSION.tar.gz) | $LINUX_SIZE | \`$LINUX_SHA\` |" >> RELEASE_NOTES.md
          echo "| ðŸŽ **macOS (Universal)** | [pywarp-macos-universal-v$VERSION.dmg](https://github.com/$REPO/releases/download/v$VERSION/pywarp-macos-universal-v$VERSION.dmg) | $MAC_SIZE | \`$MAC_SHA\` |" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "> ðŸ’¡ **Tip:** If macOS blocks the app, right-click â†’ Open â†’ Confirm, or run:" >> RELEASE_NOTES.md
          echo ">\`xattr -dr com.apple.quarantine /Applications/PyWarp.app\`" >> RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: PyWarp v${{ github.event.inputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: true
          files: |
            artifacts/**/pywarp-windows-*.zip
            artifacts/**/pywarp-ubuntu-*.tar.gz
            artifacts/**/pywarp-macos-universal-*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

